# PyQt6 地图编辑器使用说明

## 概述

这是一个基于 PyQt6 的地图编辑器，相比于 Pygame 版本，具有以下优势：

✅ **更好的跨平台支持** - PyQt6 在 macOS、Windows、Linux 上都有完美支持  
✅ **原生系统界面** - 使用系统原生 UI 组件，更符合操作系统风格  
✅ **中文支持完美** - 开箱即用，无需配置字体  
✅ **稳定性更高** - PyQt6 是成熟的企业级框架  
✅ **更易扩展** - 清晰的 Qt 框架结构，易于添加新功能  

## 安装

### 1. 安装 PyQt6

```bash
pip install PyQt6
```

### 2. 验证安装

```bash
python3 -c "from PyQt6.QtWidgets import QApplication; print('PyQt6 安装成功')"
```

## 运行

```bash
cd /Users/lqr/Desktop/Code/Ionic/Ionic\ fluorescence/Map
python3 mapEditorQT.py
```

编辑器会自动加载 `start_cave.json` 地图。

## 界面说明

### 左侧：地图编辑区
- **主要编辑区域**，显示地图网格和所有游戏对象
- **左键点击**：放置地砖或添加对象
- **右键点击**：删除地砖
- **中键拖动**：移动地图视图
- **滚轮**：缩放地图

### 右侧：工具栏

#### 地图文件
- **打开地图**：打开现有地图文件
- **保存地图**：保存当前编辑（Ctrl+S）

#### 编辑模式
选择要编辑的对象类型：
- **地砖编辑**（快捷键 1）：编辑地形
- **实体编辑**（快捷键 2）：添加/编辑实体
- **生成点编辑**（快捷键 3）：设置玩家出生点
- **敌人编辑**（快捷键 4）：添加/编辑敌人

#### 地砖选择
从下拉列表选择要放置的地砖类型。

#### 显示选项
- **显示网格**：显示/隐藏地砖网格线
- **显示实体**：显示/隐藏实体
- **显示敌人**：显示/隐藏敌人生成点
- **显示生成点**：显示/隐藏玩家出生点

#### 缩放
调整地图显示的缩放倍数（50%-300%）。

#### 当前状态
实时显示编辑器的当前状态。

## 快捷键列表

| 快捷键 | 功能 |
|--------|------|
| **1-4** | 切换编辑模式 |
| **Ctrl+S** | 保存地图 |
| **Delete** | 删除选中对象 |
| **R** | 重置视图（缩放100%，位置原点） |
| **左键** | 放置地砖/添加对象 |
| **右键** | 删除地砖 |
| **中键拖动** | 移动地图 |
| **滚轮** | 缩放地图 |

## 编辑工作流程

### 编辑地砖
1. 按 **1** 或在下拉列表选择"地砖编辑"模式
2. 在"地砖选择"下拉列表中选择要放置的地砖
3. 在地图上**左键点击**放置地砖
4. **右键点击**删除地砖（恢复为默认）

### 添加实体
1. 按 **2** 或选择"实体编辑"模式
2. 在地图上**左键点击**添加新实体
3. 已有实体用**绿色圆点**表示

### 设置玩家生成点
1. 按 **3** 或选择"生成点编辑"模式
2. 在地图上**左键点击**设置玩家出生位置
3. 生成点显示为**蓝色方块**，标记为 "P"

### 添加敌人
1. 按 **4** 或选择"敌人编辑"模式
2. 在地图上**左键点击**添加敌人生成点
3. 敌人用**红色三角形**表示

## 对象颜色说明

| 对象 | 颜色 | 形状 | 说明 |
|------|------|------|------|
| 实体 | 绿色 | 圆形 | 游戏中的特殊物体 |
| 敌人 | 红色 | 三角形 | 敌人生成点 |
| 生成点 | 蓝色 | 方块 | 玩家初始位置 |
| 网格 | 灰色 | 线条 | 地砖网格（可隐藏） |
| 选中状态 | 更亮 | 相同 | 当前选中的对象 |

## 地图文件格式

地图保存为 JSON 格式，包含以下信息：

```json
{
  "name": "start_cave",
  "playerSpawn": {
    "x": 200,
    "y": 200
  },
  "enemy": [
    {
      "id": 1,
      "spawn": [200, 300],
      "delay": 0
    }
  ],
  "tile_info": {
    "1": {
      "code": 1,
      "name": "back_stone",
      "path": "",
      "walkable": false,
      "upThroughable": false
    }
  },
  "map_info": {
    "height": 1600,
    "width": 2400,
    "tilesize": 100
  },
  "map": [[...]],
  "entity": [...]
}
```

## 故障排除

### 问题：窗口显示异常

**解决方案：** 重启编辑器，重新加载地图

### 问题：地图文件加载失败

**检查项：**
1. 确保地图文件在 `Map/` 目录中
2. 文件名与代码中的一致（不含 .json 扩展名）
3. JSON 文件格式是否正确

### 问题：修改没有保存

**解决方案：** 按 `Ctrl+S` 或点击"保存地图"按钮

### 问题：性能下降

**可能原因：** 地图过大或对象过多  
**解决方案：** 尝试隐藏不需要的对象显示

## 技术细节

### 项目结构

```
mapEditorQT.py
├── MapCanvas - 地图绘制区域（QWidget）
├── MapEditorQt - 主窗口（QMainWindow）
└── main() - 应用入口
```

### 关键类

#### MapCanvas
继承自 `QWidget`，负责地图的绘制和用户交互：
- `paintEvent()` - 绘制地图和对象
- `mousePressEvent()` - 处理地砖放置和对象添加
- `mouseMoveEvent()` - 处理地图拖动
- `wheelEvent()` - 处理缩放

#### MapEditorQt
继承自 `QMainWindow`，主应用窗口：
- `load_map()` - 加载地图文件
- `save_map()` - 保存地图文件
- `set_tile_at()` - 在指定位置放置地砖
- `add_or_select_entity()` - 添加或选择实体
- `add_or_select_enemy()` - 添加或选择敌人

## 与 Pygame 版本的对比

| 特性 | Pygame 版本 | PyQt6 版本 |
|------|-----------|-----------|
| 字体支持 | 需要配置 | 开箱即用 |
| 窗口大小调整 | 支持 | 原生支持 |
| 系统集成 | 较差 | 完美 |
| 稳定性 | 中等 | 高 |
| 学习曲线 | 陡峭 | 平缓 |
| 跨平台支持 | 有问题 | 完美 |
| 文件对话框 | 需要自己实现 | 原生支持 |
| 菜单栏 | 无 | 可添加 |

## 可能的扩展功能

1. **撤销/重做** - 记录编辑历史
2. **批量编辑** - 选区编辑
3. **图层支持** - 多层地图编辑
4. **导入/导出** - 支持其他格式
5. **快速访问** - 常用地砖快捷栏
6. **网格对齐** - 自动对齐到网格
7. **菜单栏** - 增加标准菜单
8. **搜索/替换** - 全局地砖替换

## 常见问题

**Q: 为什么改用 PyQt6？**  
A: PyQt6 提供更好的跨平台支持、更稳定的中文显示、以及更高的生产力。Pygame 主要用于游戏开发，不是 GUI 框架的最佳选择。

**Q: 能否同时使用两个版本？**  
A: 可以，两个版本使用不同的文件名，互不干扰。

**Q: 如何迁移旧的地图？**  
A: 地图文件格式相同，直接使用新编辑器打开即可。

## 支持和反馈

如有任何问题，请检查：
1. PyQt6 是否正确安装
2. Python 版本是否 >= 3.6
3. 地图文件格式是否正确
4. JSON 文件是否有语法错误

## 版本信息

- **编辑器版本:** 2.0 (PyQt6)
- **最低 Python 版本:** 3.6
- **依赖:** PyQt6
- **开发时间:** 2025年11月
